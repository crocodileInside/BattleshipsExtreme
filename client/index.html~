<!DOCTYPE html>
	<head>
		<title>Schiffe Versenken Extreme</title>
		
		<meta charset="utf-8">
		<meta http-equiv="Content-type" content="text/html; charset=UTF-8" />
		
		<link rel="stylesheet" type="text/css" href="main.css">
		
		<script type="text/javascript" src="js/jquery-2.0.3.min.js"></script>
		<script type="text/javascript" src="js/jquery-ui.js"></script>
		<script type="text/javascript" src="js/qr/sha1.js"></script>
		<script type="text/javascript" src="js/CardDatabase.js"></script>
		<script type="text/javascript" src="js/qr/qrscanner.js"></script>
		<script src='https://cdn.firebase.com/v0/firebase.js'></script>
		
		<script type="text/javascript">
			// Client
			
			var fbref = new Firebase('https://battleships.firebaseio.com/cc/');
			
			var clientID = -1;	
			var clientName = "";
			var myCards = Array();
			var myShips = Array();
			
			
			fbref.on('child_added', function(snapshot) {
				var message = snapshot.val();
				if(message)
					parseMessage(message);
			});	
			
			function parseMessage(message)
			{
				if(message.action)
				{
					switch(message.action)
					{
						case 'clientInit':
							if(!message.error){
								clientID = message.clientID;
								$('div#preparationContainer').show();
								addChatText('system', 'Client initialized!');
							}else{
								addChatText('error', 'Error: ' + message.error);
								console.log(message.error);
							}
						break;
						
						case 'clientReady':
							addChatText('system', 'We are ready, waiting for other players...');
						break;
						
						case 'gameStart':
							addChatText('system', 'Game started!');
							$('div#gameContainer').show();
						break;
						
						case 'getCard':
							addChatText('system', 'Das Team hat eine Karte bekommen!');
							addCard(message.card);
						break;
					}
				}
			}
			
			function pushMessage(msg)
			{
				fbref.push(msg);
			}
			
			
			function generateField()
			{
				for(var y = 0; y < 10; y++)
				{
					for(var x = 0; x < 12; x++)
					{
						$('div#gameField').append($('<div />').attr('id', 'field-'+x+'-'+y));
					}
				}
				
				$('div#gameField div').click(function(){
					var strArr = $(this).attr('id').split('-');
					var x = parseInt(strArr[1]);
					var y = parseInt(strArr[2]);
					
					console.log("clicked on x: " + x + "  Y: " + y);
					setShip(x, y, 3, 0);
				});
			}
			
			
			function setShip(x, y, len, rotated)
			{
				var tmpShipFields = Array();
				for(var n = 0; n < len; n++)
				{
					if(rotated)
					{
						tmpShipFields.push([x, y+n]);
					}
					else
					{
						tmpShipFields.push([x+n, y]);
					}
				}	
				
				var shipCollision = false;
				for(var i = 0; i < myShips.length; i++)
				{
					var intersection = arr_intersect(myShips[i].fields, tmpShipFields);
					if(intersection && intersection.length > 0)
					{
						shipCollision = true;
						console.log("intersection");
					}
				}
				
				if(!shipCollision)
				{
					console.log("ok");
					myShips.push({length: len, rotated: rotated, fields: tmpShipFields});
					drawShips();
				}
				else
				{
					addChatText('error', 'Das Schiff kann hier nicht gesetzt werden!');
				}
			}
			
			function drawShips()
			{
				for(var i = 0; i < myShips.length; i++)
				{
					for(n = 0; n < myShips[i].fields.length; n++)
					{
						$('div#gameField div#field-'+myShips[i].fields[n][0]+'-'+myShips[i].fields[n][1]).addClass('ship');
					}
				}
			}
			
			function arr_intersect(a, b)
			{
				var ai=0, bi=0;
				var result = new Array();
				
				while( ai < a.length && bi < b.length )
				{
					if      (a[ai] < b[bi] ){ ai++; }
					else if (a[ai] > b[bi] ){ bi++; }
					else /* they're equal */
					{
						result.push(a[ai]);
						ai++;
						bi++;
					}
				}
				
				return result;
			}
			
			function safe_tags(str) {
				return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') ;
			}
			
			function addCard(card)
			{
				var cType = cardTypes[card.cardType];
				myCards.push(card);
				$('div#cardContainer').append($('<div />').addClass('cardItem').prepend($('<img>').attr('src', 'img/'+cType.cardImage)).append(cType.cardName));
			}
			
			$('#messageInput').keypress(function (e) {
				if (e.keyCode == 13) {
				var name = $('#nameInput').val();
				var text = $('#messageInput').val();
				fbref.push({name: name, text: text});
				$('#messageInput').val('');
				}
			});
			
			
			function displayChatMessage(name, text) {
				$('<div/>').text(text).prepend($('<em/>').text(name+': ')).appendTo($('#messagesDiv'));
				$('#messagesDiv')[0].scrollTop = $('#messagesDiv')[0].scrollHeight;
			};
			
			function addChatText(type, str)
			{
				$('div#chatContainer').append($('<div />').addClass(type).text(str));
			}
		
			function setStatusText(str)
			{
				$('div#statusBar').text(str);
			}
		
			$(document).ready(function() {
				generateField();
				
				addChatText('system', 'Client init');
				
				fbref.child('handshake').set('clientInit');
				
				$('#btnStartGame').click(function(){
					clientName = safe_tags($('input#teamName').val());
					if(clientName != '' && myShips.length == 5){
						pushMessage({clientID: clientID, action: 'clientReady', clientName: clientName, clientShips: myShips});
						$('div#preparationContainer').hide();
						addChatText('system', 'Waiting for server...');
					}else
					{
						addChatText('error', 'Noch nicht alle Schiffe gesetzt oder noch kein Teamname gew√§hlt');
					}
				});
				
				$('#btnScanCard').click(function(){
					
				});
			});
		</script>
	</head>
	
	<body>
		<div id="preparationContainer">
			<div id="gameField"></div>
			<div id="shipContainer"></div>
			<input type="text" id="teamName" placeholder="Teamname">
			<button id="btnStartGame">Bereit</button>
		</div>
		
		<div id="gameContainer">
			<div id="cardContainer">
			</div>
			
			<div id="chatContainer"></div>
			
			<div id="scanContainer">
				<button id="btnScanCard">Karte Scannen</button>
				<video id="scanVideoFrame" autoplay></video>
				<canvas id="qr-canvas"></canvas>
			</div>
		</div>
	</body>
</html>